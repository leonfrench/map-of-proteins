import{b as x,g as W,m as M,a as U,d as V,c as Y,e as Q}from"./getColorTheme-6e4d233d.js";import{c as D}from"./config-cec912d5.js";import"./index-47111b55.js";let T,w=new Map;async function _(){T=await(await fetch(D.placesSource,{mode:"cors"})).json(),T.features.forEach(r=>{w.set(r.properties.labelId,r)});const o=oe(),s=re(o);return s&&x.fire("unsaved-changes-detected",s),o}function Z(e){localStorage.setItem("places",JSON.stringify(e))}function ee(e,o,s,r,c){let i=W();for(;w.has(i);)i=W();const l={type:"Feature",geometry:{type:"Point",coordinates:[s.lng,s.lat].map(f=>Math.round(f*1e3)/1e3)},properties:{symbolzoom:Math.ceil(r),name:o,labelId:i}};return c!==void 0&&(l.properties.ownerId=c),e.features.push(l),w.set(i,l),Z(e),e}function te(e,o,s,r,c){if(!s)o.features=o.features.filter(i=>i.properties.labelId!==e),w.delete(e);else{const i=o.features.find(l=>l.properties.labelId===e);i.properties.name=s,i.properties.symbolzoom=Math.ceil(c),i.geometry.coordinates=[r.lng,r.lat].map(l=>Math.round(l*1e3)/1e3),w.set(e,i)}return Z(o),o}function oe(){const e=JSON.parse(localStorage.getItem("places"))||{type:"FeatureCollection",features:[]};let o=new Map;for(const s of e.features){const r=s.properties.labelId,c=o.get(r);c?o.set(r,Object.assign({},c,s)):o.set(r,s)}return w.forEach((s,r)=>{o.has(r)||o.set(r,s)}),{type:"FeatureCollection",features:Array.from(o.values())}}function re(e){if(!T)return!1;for(const o of e.features){const s=o.properties.labelId,r=w.get(s);if(!r||r.properties.name!==o.properties.name||r.properties.symbolzoom!==o.properties.symbolzoom||r.geometry.coordinates[0]!==o.geometry.coordinates[0]||r.geometry.coordinates[1]!==o.geometry.coordinates[1])return!0}return!1}function X(e,o,s){const r=document.createElement("div");r.className="label-marker",r.innerHTML=`<form class="mini-label">
  <input type="text" placeholder="Label" />
  <div class='commands'>
    <a href='#' class="cancel" tabindex="3">Cancel</a>
    <a href='#' class="accept">Save</a>
  </div>
  </div>`,s&&(r.querySelector("input").value=s);let c,i=0,l=0,f=0,g=0;return b(),{element:r,setMarker:t=>{c=t}};function u(t){t.preventDefault(),o(r.querySelector("input").value),v()}function b(){document.addEventListener("keydown",E),r.querySelector("form").addEventListener("submit",u),r.querySelector(".cancel").addEventListener("click",t=>{t.preventDefault(),v()}),r.querySelector(".accept").addEventListener("click",t=>{u(t)}),r.addEventListener("pointerdown",t=>{i=t.clientX,l=t.clientY;let n=e.project(c.getLngLat());f=n.x-i,g=n.y-l,window.addEventListener("pointermove",L,!0),window.addEventListener("pointerup",C,!0)})}function L(t){const n=e.unproject([t.clientX+f,t.clientY+g]);c.setLngLat(n)}function C(){document.removeEventListener("keydown",E),window.removeEventListener("pointermove",L,!0),window.removeEventListener("pointerup",C,!0)}function v(){c.remove(),C()}function E(t){t.key==="Escape"&&(v(),t.preventDefault())}}function ne(e){let o;const s=["place-country-1"];return _().then(l=>{e.getSource("place").setData(l),o=l}),{getContextMenuItems:r,getPlaces:()=>o};function r(l,f){const g=e.queryRenderedFeatures(l.point,{layers:s});let u=[];if(g.length){const b=g[0].properties;u.push({text:`Edit ${b.name}`,click:()=>i(g[0].geometry.coordinates,b)})}else u.push({text:"Add label",click:()=>c(l.lngLat,f)});return u}function c(l,f){const g=X(e,b),u=new M.Popup({closeButton:!1});u.setDOMContent(g.element),u.setLngLat(l),u.addTo(e),g.setMarker(u);function b(L){L&&(o=ee(o,L,u.getLngLat(),e.getZoom(),f),e.getSource("place").setData(o),x.fire("unsaved-changes-detected",!0))}}function i(l,f){const g=X(e,b,f.name),u=new M.Popup({closeButton:!1});u.setDOMContent(g.element),u.setLngLat(l),u.addTo(e),g.setMarker(u);function b(L){o=te(f.labelId,o,L,u.getLngLat(),e.getZoom()),e.getSource("place").setData(o),x.fire("unsaved-changes-detected",!0)}}}const se="#bf2072",le="#e56aaa",h=Q(),q=["case"];h.color.forEach(e=>{q.push(["==",["get","fill"],e.input],e.output)});q.push("#FF0000");function fe(){const e=new M.Map(ae());e.dragRotate.disable(),e.touchZoomRotate.disableRotation();const o=Y();let s,r;e.on("load",()=>{e.addLayer(o,"circle-layer"),r=ne(e)}),e.on("contextmenu",t=>{x.fire("show-tooltip");let n=C(t.point);if(!n)return;const d={items:r.getContextMenuItems(t,n.id),left:t.point.x+"px",top:t.point.y+"px"};d.items.push(f(n));const a=E(t.point);if(a){let p=a.properties.label,y=p.split("/");const z=y[y.length-1]||p;d.items.push({text:"List connections of "+z,click:()=>{l(a),v(t.point,p),x.fire("focus-on-repo",p,n.id)}})}x.fire("show-context-menu",d)}),e.on("mousemove",t=>{}),e.on("click",t=>{x.fire("show-context-menu");const n=E(t.point);if(!n)return;const d=n.properties.label;if(!d)return;l(n);const a=t.originalEvent.altKey;v(t.point,d,!a)});const c=fetch(D.bordersSource).then(t=>t.json());return{map:e,dispose(){e.remove()},makeVisible:L,clearHighlights:b,clearBorderHighlights:u,getPlacesGeoJSON:g,getGroupIdAt:i};function i(t,n){return c.then(d=>{const a=d.features.find(y=>ce(y.geometry.coordinates[0],t,n));return a?a.id:void 0})}function l(t){var p;const n=t.properties.label;if(!n)return;const[d,a]=t.geometry.coordinates;x.fire("show-tooltip"),x.fire("repo-selected",{text:n,lat:d,lon:a,groupId:(p=t.properties)==null?void 0:p.parent})}function f(t){return{text:"Show largest projects",click:()=>{let n=new Map,d=e.querySourceFeatures("points-source",{sourceLayer:"points",filter:["==","parent",t.id]}).sort((a,p)=>p.properties.size-a.properties.size);for(let a of d){let p={name:a.properties.label,lngLat:a.geometry.coordinates};if(!n.has(a.properties.label)&&(n.set(a.properties.label,p),n.size>=100))break}e.setFilter("border-highlight",["==",["id"],t.id]),e.setLayoutProperty("border-highlight","visibility","visible"),x.fire("show-largest-in-group",t.id,Array.from(n.values()))}}}function g(){return r.getPlaces()}function u(){e.setLayoutProperty("border-highlight","visibility","none")}function b(){o.clear(),e.getSource("selected-nodes").setData({type:"FeatureCollection",features:[]}),e.redraw()}function L(t,n,d=!1){d?e.jumpTo(n):e.flyTo(n),e.once("moveend",()=>{v(n.center,t)})}function C(t){return e.queryRenderedFeatures(t,{layers:["polygon-layer"]})[0]}function v(t,n,d=!0){const a=C(t);if(!a)return;const p=a.id;if(p===void 0)return;const y=ie(a.properties);let z=U(y);o.clear(),s==null||s.cancel();let F=!1,S={type:"FeatureCollection",features:[]};s=V(p).then(k=>{if(F)return;let I=[],j,N=new Map;e.querySourceFeatures("points-source",{sourceLayer:"points",filter:["==","parent",p]}).forEach(m=>{const P=m.geometry.coordinates;N.set(m.properties.label,{lngLat:P})}),k.forEachLink(m=>{var G,J,K;if((G=m.data)!=null&&G.e&&d)return;const P=((J=N.get(m.fromId))==null?void 0:J.lngLat)||k.getNode(m.fromId).data.l,R=((K=N.get(m.toId))==null?void 0:K.lngLat)||k.getNode(m.toId).data.l,H=M.MercatorCoordinate.fromLngLat(P),O=M.MercatorCoordinate.fromLngLat(R),B=n===m.fromId||n===m.toId,A={from:[H.x,H.y],to:[O.x,O.y],color:B?4294967295:z};if(B){I.push(A),j||(j=n===m.fromId?P:R,S.features.push({type:"Feature",geometry:{type:"Point",coordinates:j},properties:{color:se,name:n,background:y,textSize:1.2}}));let $=n===m.fromId?m.toId:m.fromId;S.features.push({type:"Feature",geometry:{type:"Point",coordinates:n===m.fromId?R:P},properties:{color:le,name:$,background:y,textSize:.8}})}else o.addLine(A)}),I.forEach(m=>{o.addLine(m)}),e.getSource("selected-nodes").setData(S),e.redraw()}),s.cancel=()=>{F=!0}}function E(t){let n=16,d=16;const a=e.queryRenderedFeatures([[t.x-n/2,t.y-d/2],[t.x+n/2,t.y+d/2]],{layers:["circle-layer"]});if(!a.length)return;let p=1/0,y=null;return a.forEach(z=>{let F=z.geometry.coordinates,S=F[0]-t.x,k=F[1]-t.y,I=S*S+k*k;I<p&&(p=I,y=z)}),y}}function ae(){return{hash:!0,container:"map",center:[0,0],zoom:2,style:{version:8,glyphs:D.glyphsSource,sources:{"borders-source":{type:"geojson",data:D.bordersSource},"points-source":{type:"vector",tiles:[D.vectorTilesTiles],minzoom:3,maxzoom:5,center:[-9.84375,4.213679,7]},place:{type:"geojson",data:{type:"FeatureCollection",features:[]}},"selected-nodes":{type:"geojson",data:{type:"FeatureCollection",features:[]}}},layers:[{id:"background",type:"background",paint:{"background-color":h.background}},{id:"polygon-layer",type:"fill",source:"borders-source",filter:["==","$type","Polygon"],paint:{"fill-color":q}},{id:"border-highlight",type:"line",source:"borders-source",layout:{visibility:"none"},paint:{"line-color":"#FFF","line-width":4}},{id:"circle-layer",type:"circle",source:"points-source","source-layer":"points",filter:["==","$type","Point"],paint:{"circle-color":h.circleColor,"circle-opacity":["interpolate",["linear"],["zoom"],5,.1,15,.9],"circle-stroke-color":h.circleStrokeColor,"circle-stroke-width":1,"circle-stroke-opacity":["interpolate",["linear"],["zoom"],8,0,15,.9],"circle-radius":["interpolate",["linear"],["zoom"],5,["*",["get","size"],.1],23,["*",["get","size"],1.5]]}},{id:"label-layer",type:"symbol",source:"points-source","source-layer":"points",filter:[">=",["zoom"],3],layout:{"text-font":["Roboto Condensed Regular"],"text-field":["slice",["get","label"],["+",["index-of","/",["get","label"]],1]],"text-anchor":"top","text-max-width":10,"symbol-sort-key":["-",0,["get","size"]],"symbol-spacing":500,"text-offset":[0,.5],"text-size":["interpolate",["linear"],["zoom"],8,["/",["get","size"],4],10,["+",["get","size"],8]]},paint:{"text-color":h.circleLabelsColor,"text-halo-color":h.circleLabelsHaloColor,"text-halo-width":h.circleLabelsHaloWidth}},{id:"selected-nodes-layer",type:"circle",source:"selected-nodes",paint:{"circle-color":["get","color"]}},{id:"selected-nodes-labels-layer",type:"symbol",source:"selected-nodes",layout:{"text-font":["Roboto Condensed Regular"],"text-field":["get","name"],"text-anchor":"top","text-max-width":10,"symbol-sort-key":["-",0,["get","textSize"]],"symbol-spacing":500,"text-offset":[0,.5],"text-size":["interpolate",["linear"],["zoom"],8,["/",["get","size"],4],10,["+",["get","size"],8]]},paint:{"text-color":"#fff","text-halo-color":["get","color"],"text-halo-width":2}},{id:"place-country-1",maxzoom:10,type:"symbol",source:"place",layout:{"text-font":["Roboto Condensed Bold"],"text-size":["interpolate",["cubic-bezier",.2,0,.7,1],["zoom"],1,["step",["get","symbolzoom"],15,4,13,5,12],9,["step",["get","symbolzoom"],22,4,19,5,17]],"symbol-sort-key":["get","symbolzoom"],"text-field":"{name}","text-max-width":6,"text-line-height":1.1,"text-letter-spacing":0},paint:{"text-color":h.placeLabelsColor,"text-halo-color":h.placeLabelsHaloColor,"text-halo-width":h.placeLabelsHaloWidth},filter:["<=",["get","symbolzoom"],["+",["zoom"],4]]}]}}}function ie(e){for(const o of h.color)if(o.input===e.fill)return o.output;return e.fill}function ce(e,o,s){let r=!1;for(let c=0,i=e.length-1;c<e.length;i=c++){const l=e[c],f=e[i];l[1]>s!=f[1]>s&&o<(f[0]-l[0])*(s-l[1])/(f[1]-l[1])+l[0]&&(r=!r)}return r}export{fe as default};
//# sourceMappingURL=createMap-94b7ba8f.js.map
